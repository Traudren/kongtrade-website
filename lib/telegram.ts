
interface TelegramMessage {
  chat_id: string
  text: string
  parse_mode?: string
  document?: {
    filename: string
    content: string
  }
}

export class TelegramBot {
  private token: string
  private adminId: string

  constructor() {
    this.token = '7585793273:AAFw5sP4xz0WnFYL2P3Vgm4jRjef_RgRKGc'
    this.adminId = '5351584188'
  }

  async sendMessage(text: string): Promise<boolean> {
    try {
      const response = await fetch(`https://api.telegram.org/bot${this.token}/sendMessage`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          chat_id: this.adminId,
          text: text,
          parse_mode: 'HTML',
        }),
      })

      return response.ok
    } catch (error) {
      console.error('Telegram send message error:', error)
      return false
    }
  }

  async sendDocument(text: string, filename: string, fileContent: string): Promise<boolean> {
    try {
      const formData = new FormData()
      formData.append('chat_id', this.adminId)
      formData.append('caption', text)
      formData.append('parse_mode', 'HTML')
      
      // –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª Blob
      const blob = new Blob([fileContent], { type: 'text/plain' })
      formData.append('document', blob, filename)

      const response = await fetch(`https://api.telegram.org/bot${this.token}/sendDocument`, {
        method: 'POST',
        body: formData,
      })

      return response.ok
    } catch (error) {
      console.error('Telegram send document error:', error)
      return false
    }
  }

  async notifyNewPayment(user: any, subscription: any, payment: any, userConfig: any): Promise<boolean> {
    try {
      const message = `üîî <b>–ù–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂!</b>

üë§ <b>User:</b> ${user.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'} (${user.email})
üíé <b>–ü–æ–¥–ø–∏—Å–∫–∞:</b> ${subscription.planName}
‚è∞ <b>–ü–µ—Ä–∏–æ–¥:</b> ${subscription.planType === 'monthly' ? '1 –º–µ—Å—è—Ü' : '3 –º–µ—Å—è—Ü–∞'}
üí∞ <b>–°—É–º–º–∞:</b> $${payment.amount}
üè¶ <b>–ë–∏—Ä–∂–∞:</b> ${payment.paymentMethod}
üÜî <b>TXID:</b> ${payment.txid || '–ù–µ —É–∫–∞–∑–∞–Ω'}

üìÑ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω`

      // –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
      const configContent = `api_key = '${userConfig?.apiKey || 'H3k0nTfgfd4342fbdwmi1G6KB1JHH'}'
api_secret = '${userConfig?.apiSecret || 'ZRMGwy3Dc0aGjjYE38Obfsgefgf5304gpazMFgP26Wm6Y'}'
tg_token_main = "${userConfig?.telegramToken || '8159634915:AAGLifkNfMfegg5iws0t8Lj0kdpVgG-IdKFNB54'}"
admin_id = "${userConfig?.adminId || '5351584153212699688'}"`

      const filename = `${user.name || user.email.split('@')[0]}_config.txt`
      
      return await this.sendDocument(message, filename, configContent)
    } catch (error) {
      console.error('Error notifying new payment:', error)
      return false
    }
  }
}
